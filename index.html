<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H·ªá th·ªëng c·∫£nh b√°o ch√°y (ESP32 + MQTT)</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin:16px; background:#0b1020; color:#e8edf7; }
    h1 { margin:0 0 16px; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); }
    .card { background:#121833; border:1px solid #20295a; border-radius:16px; padding:16px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, select { background:#0f172a; color:#e2e8f0; border:1px solid #334155; padding:8px 10px; border-radius:8px; }
    button { background:#334155; color:#e2e8f0; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; transition:filter .15s; }
    button:hover { filter:brightness(1.1); }
    .pill { padding:4px 10px; border-radius:999px; font-weight:700; }
    .ok{ background:#193d2f; color:#86efac; } .bad{ background:#4a1d1d; color:#fecaca; } .warn{ background:#3b2d14; color:#fde68a; }
    canvas { background:#0f172a; border-radius:12px; padding:8px; }
    .logwrap { max-height:260px; overflow:auto; background:#0f172a; border-radius:8px; padding:8px; }
    .log-line { display:flex; gap:8px; align-items:flex-start; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12.5px; line-height:1.3; }
    .log-time { opacity:.7; min-width:88px; }
    .log-tag { padding:2px 6px; border-radius:6px; font-weight:700; }
    .tag-rx{  background:#12381e; color:#86efac; }
    .tag-tx{  background:#0f2d3a; color:#93c5fd; }
    .tag-sys{ background:#2a2438; color:#e9d5ff; }
    .tag-err{ background:#4a1d1d; color:#fecaca; }
    .log-text { white-space:pre-wrap; word-break:break-word; }
    .controls { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .muted { opacity:.65 }

    /* √î LED hi·ªÉn th·ªã tr·∫°ng th√°i */
    .ledbox {
      height: 84px; border-radius:12px; display:flex; align-items:center; justify-content:center;
      background:#334155; color:#e2e8f0; font-weight:800; letter-spacing:1px; font-size:18px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.04);
      user-select:none;
    }
    .ledbox.alarm {
      background:#7f1d1d; color:#fecaca; box-shadow:0 0 0 2px #7f1d1d, 0 0 18px rgba(127,29,29,.55) inset;
      animation: alarmPulse 1s ease-in-out infinite;
    }
    @keyframes alarmPulse {
      0%   { filter:brightness(1.0); transform:scale(1.00); }
      50%  { filter:brightness(1.25); transform:scale(1.02); }
      100% { filter:brightness(1.0); transform:scale(1.00); }
    }

    /* Banner c·∫£nh b√°o */
    .banner { display:none; position:fixed; inset:0; place-items:center; background:rgba(0,0,0,.6); }
    .banner .inner { background:#1b0b0b; border:2px solid #7f1d1d; padding:24px; border-radius:16px; text-align:center; }
  </style>
</head>
<body>
  <h1>üî• H·ªÜ TH·ªêNG C·∫¢NH B√ÅO CH√ÅY</h1>

  <div class="grid">
    <!-- K·∫øt n·ªëi -->
    <div class="card">
      <h3>K·∫øt n·ªëi MQTT</h3>
      <div class="row">
        <input id="brokerUrl" style="flex:1 1 320px" value="wss://test.mosquitto.org:8081/mqtt" />
        <input id="rootBase" value="iot/fire" title="G·ªëc topic. Firmware: iot/fire/&lt;chipId&gt;/..." />
        <button id="btnConnect">K·∫øt n·ªëi</button>
        <span id="connState" class="pill warn">Ch∆∞a k·∫øt n·ªëi</span>
      </div>
      <small>Thi·∫øt b·ªã publish: <code>iot/fire/&lt;chipIdHex&gt;/...</code></small>
    </div>

    <!-- Thi·∫øt b·ªã + LED indicator + ƒëi·ªÅu khi·ªÉn -->
    <div class="card">
      <h3>Thi·∫øt b·ªã</h3>
      <div class="row">
        <label for="deviceSel">Ch·ªçn:</label>
        <select id="deviceSel" style="min-width:160px"><option value="">(ch∆∞a ph√°t hi·ªán)</option></select>
        <span id="devStatus" class="pill warn">unknown</span>
      </div>
      <p class="muted" id="devBase">(ch∆∞a c√≥)</p>

      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin:8px 0 10px;">
        <div class="ledbox" id="ledBox">‚ö™ SAFE</div>
        <div style="display:flex; flex-direction:column; gap:6px; justify-content:center;">
          <div>Nhi·ªát ƒë·ªô: <b id="tempNow">--</b> ¬∞C</div>
          <div>ƒê·ªô ·∫©m: <b id="humNow">--</b> %</div>
          <div>Kh√≥i: <b id="smokeNow">--</b></div>
        </div>
      </div>

      <div class="row">
        <button id="btnClear">CLEAR ALARM</button>
        <button id="btnLedOn">LED ON</button>
        <button id="btnLedOff">LED OFF</button>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="card" style="grid-column:1/-1;">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0">Bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô</h3>
        <div class="row">
          <label for="mode">Ch·∫ø ƒë·ªô:</label>
          <select id="mode">
            <option value="realtime">Realtime</option>
            <option value="today">Trong ng√†y (theo gi·ªù)</option>
            <option value="session">Theo bu·ªïi</option>
          </select>
        </div>
      </div>
      <canvas id="chart" height="140"></canvas>
    </div>

    <!-- Log -->
    <div class="card" style="grid-column:1/-1;">
      <h3>Log</h3>
      <div class="controls">
        <button id="btnClearLog">Clear</button>
        <button id="btnDownload">Download .txt</button>
        <label><input type="checkbox" id="autoScroll" checked /> Auto-scroll</label>
      </div>
      <div id="logWrap" class="logwrap"><div id="logList"></div></div>
    </div>
  </div>

  <!-- Banner c·∫£nh b√°o -->
  <div id="alertBanner" class="banner">
    <div class="inner">
      <h2>‚ö†Ô∏è PH√ÅT HI·ªÜN CH√ÅY</h2>
      <p id="alertText">Chi ti·∫øt...</p>
      <div class="row" style="justify-content:center; margin-top:12px;">
        <button id="btnAck">ƒê√£ hi·ªÉu</button>
      </div>
    </div>
  </div>

  <audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ===== Helpers & Log =====
    const $ = (id) => document.getElementById(id);
    const setConnState = (s, cls='warn') => { const el=$('connState'); el.textContent=s; el.className='pill '+cls; };
    const logStore=[]; const nowTs = () => new Date().toLocaleTimeString();
    function logLine(kind,text){
      const list=$('logList'), scroller=$('logWrap');
      const line=document.createElement('div'); line.className='log-line';
      const tm=document.createElement('span'); tm.className='log-time'; tm.textContent=nowTs();
      const tag=document.createElement('span'); tag.className='log-tag '+(kind==='rx'?'tag-rx':kind==='tx'?'tag-tx':kind==='err'?'tag-err':'tag-sys'); tag.textContent=kind.toUpperCase();
      const body=document.createElement('span'); body.className='log-text'; body.textContent=text;
      line.append(tm,tag,body); list.appendChild(line);
      logStore.push(`[${tm.textContent}] ${kind.toUpperCase()} ${text}`);
      if($('autoScroll').checked) scroller.scrollTop=scroller.scrollHeight;
    }
    $('btnClearLog').onclick=()=>{ $('logList').innerHTML=''; logStore.length=0; };
    $('btnDownload').onclick=()=>{ const b=new Blob([logStore.join('\n')],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`mqtt-log-${Date.now()}.txt`; a.click(); URL.revokeObjectURL(a.href); };

    // ===== State =====
    let client=null;
    let rootBase='iot/fire';
    const devices = new Map(); // chipId -> {status, lastTele, dataRealtime:[], dataToday:Map, alarm:false}

    // ===== Chart =====
    const chart=new Chart($('chart').getContext('2d'),{
      type:'line',
      data:{labels:[],datasets:[{label:'Nhi·ªát ƒë·ªô (¬∞C)',data:[],fill:false,tension:.2}]},
      options:{responsive:true,scales:{y:{beginAtZero:false}}}
    });
    function redrawChart(chip){
      const m=$('mode').value;
      const dev=devices.get(chip); if(!dev) return;
      if(m==='realtime'){
        chart.data.labels=dev.dataRealtime.map(p=>p.t.toLocaleTimeString());
        chart.data.datasets[0].data=dev.dataRealtime.map(p=>p.v);
      }else if(m==='today'){
        const hours=[...dev.dataToday.keys()].sort((a,b)=>a-b);
        const avg=a=>a.reduce((s,x)=>s+x,0)/a.length;
        chart.data.labels=hours.map(h=>h+':00');
        chart.data.datasets[0].data=hours.map(h=>avg(dev.dataToday.get(h)));
      }else{
        const buckets={'S√°ng':[],'Tr∆∞a':[],'Chi·ªÅu':[],'T·ªëi':[]};
        for(const {t,v} of dev.dataRealtime){
          const h=t.getHours();
          if(h>=5&&h<11) buckets['S√°ng'].push(v);
          else if(h>=11&&h<13) buckets['Tr∆∞a'].push(v);
          else if(h>=13&&h<17) buckets['Chi·ªÅu'].push(v);
          else if(h>=17&&h<22) buckets['T·ªëi'].push(v);
        }
        const avg=a=>a.length?(a.reduce((s,x)=>s+x,0)/a.length):null;
        chart.data.labels=Object.keys(buckets);
        chart.data.datasets[0].data=Object.values(buckets).map(avg);
      }
      chart.update();
    }
    $('mode').addEventListener('change',()=>redrawChart($('deviceSel').value));

    // ===== UI bindings =====
    function setDevStatus(txt, cls='warn'){ const el=$('devStatus'); el.textContent=txt; el.className='pill '+cls; }
    function updateLed(chip){
      const dev=devices.get(chip);
      const box=$('ledBox');
      if(!dev || !dev.alarm){
        box.classList.remove('alarm');
        box.textContent='‚ö™ SAFE';
      } else {
        box.classList.add('alarm');
        box.textContent='üî¥ ALARM';
      }
    }
    function updateTopFields(chip){
      const dev=devices.get(chip);
      $('devBase').textContent = chip ? `${rootBase}/${chip}/...` : '(ch∆∞a c√≥)';
      if(!dev){ $('tempNow').textContent='--'; $('humNow').textContent='--'; $('smokeNow').textContent='--'; setDevStatus('unknown','warn'); updateLed(''); return; }
      const tele=dev.lastTele||{};
      $('tempNow').textContent=typeof tele.temp_c==='number'?tele.temp_c.toFixed(1):'--';
      $('humNow').textContent=(tele.hum??'--');
      $('smokeNow').textContent=(tele.smoke_raw??'--');
      setDevStatus(dev.status==='online'?'online':'offline', dev.status==='online'?'ok':'bad');
      updateLed(chip);
      redrawChart(chip);
    }

    // ===== Device discovery =====
    function addDeviceIfNeeded(chip){
      if(!devices.has(chip)){
        devices.set(chip,{status:'unknown', lastTele:null, dataRealtime:[], dataToday:new Map(), alarm:false});
        const opt=document.createElement('option'); opt.value=chip; opt.textContent=chip; $('deviceSel').appendChild(opt);
        if(!$('deviceSel').value){ $('deviceSel').value=chip; updateTopFields(chip); }
      }
    }
    $('deviceSel').addEventListener('change',()=>updateTopFields($('deviceSel').value));

    // ===== Notifications & banner =====
    function ensureNotif(){ if('Notification' in window && Notification.permission==='default') Notification.requestPermission(); }
    function showAlert(chip,payload){
      const text=`üî• FIRE @ ${new Date((payload.ts||Date.now()/1000)*1000).toLocaleString()} ‚Äî T=${payload.temp_c}¬∞C, smoke=${payload.smoke_raw} ‚Äî ${chip}`;
      $('alertText').textContent=text;
      $('alertBanner').style.display='grid';
      try{ $('beep').play(); }catch{}
      if('Notification' in window && Notification.permission==='granted') new Notification('Ph√°t hi·ªán ch√°y',{body:text});
    }
    $('btnAck').onclick=()=>{ $('alertBanner').style.display='none'; };

    // ===== MQTT =====
    function connect(){
      const url=$('brokerUrl').value.trim();
      rootBase=($('rootBase').value.trim()||'iot/fire').replace(/\/+$/,'');
      ensureNotif();
      const opts={clientId:'webdash-'+Math.random().toString(16).slice(2), keepalive:60, clean:true};
      const sub = `${rootBase}/+/+`;
      client=mqtt.connect(url,opts);
      client.on('connect',()=>{
        setConnState('ƒê√£ k·∫øt n·ªëi','ok');
        logLine('sys',`[MQTT] connected to ${url}`);
        client.subscribe(sub, (err)=>{ if(err) logLine('err','subscribe error: '+err.message); else logLine('sys','subscribed: '+sub); });
      });
      client.on('reconnect',()=>setConnState('ƒêang k·∫øt n·ªëi l·∫°i...','warn'));
      client.on('close',()=>setConnState('M·∫•t k·∫øt n·ªëi','bad'));
      client.on('error',e=>{ logLine('err','[MQTT error] '+e.message); setConnState('L·ªói','bad'); });
      client.on('message',(topic,msg)=>handleMsg(topic, msg.toString()));
    }
    function publish(topic,payload){ if(!client||!client.connected) return; client.publish(topic,payload); logLine('tx',`‚Üí ${topic}: ${payload}`); }
    function parseChip(topic){
      // rootBase/<chipId>/<leaf>
      const t = topic.split('/'); const rb = rootBase.split('/').length; return t[rb];
    }

    function handleMsg(topic,s){
      logLine('rx',`‚Üê ${topic}: ${s}`);
      const chip = parseChip(topic); if(!chip) return;
      addDeviceIfNeeded(chip);
      const dev = devices.get(chip);

      if(topic.endsWith('/status')){
        dev.status = s.trim();
        if($('deviceSel').value===chip) updateTopFields(chip);

      } else if(topic.endsWith('/telemetry')){
        try{
          const o=JSON.parse(s);
          dev.lastTele = o;
          const t=new Date(((o.ts??(Date.now()/1000)))*1000);
          if(typeof o.temp_c==='number'){
            dev.dataRealtime.push({t, v:o.temp_c});
            if(dev.dataRealtime.length>200) dev.dataRealtime.shift();
            const h=t.getHours();
            if(!dev.dataToday.has(h)) dev.dataToday.set(h,[]);
            dev.dataToday.get(h).push(o.temp_c);
          }
          if(typeof o.alarm==='boolean') dev.alarm = o.alarm;
          if($('deviceSel').value===chip) updateTopFields(chip);
        }catch(e){ logLine('err','JSON parse telemetry: '+e.message); }

      } else if(topic.endsWith('/alert')){
        try{ const p=JSON.parse(s); dev.alarm=true; if($('deviceSel').value===chip) updateLed(chip); showAlert(chip,p); }
        catch{ dev.alarm=true; if($('deviceSel').value===chip) updateLed(chip); showAlert(chip,{ts:Date.now()/1000, temp_c:'?', smoke_raw:'?'}) }
      }
    }

    // ===== Buttons =====
    $('btnConnect').onclick=connect;
    $('btnClear').onclick =()=>{ const chip=$('deviceSel').value; if(chip){ publish(`${rootBase}/${chip}/cmd/alarm`, 'clear'); const d=devices.get(chip); if(d){ d.alarm=false; updateLed(chip); } } };
    $('btnLedOn').onclick =()=>{ const chip=$('deviceSel').value; if(chip) publish(`${rootBase}/${chip}/cmd/led`, 'on'); };
    $('btnLedOff').onclick=()=>{ const chip=$('deviceSel').value; if(chip) publish(`${rootBase}/${chip}/cmd/led`, 'off'); };
  </script>
</body>
</html>
