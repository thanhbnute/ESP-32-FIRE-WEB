<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H·ªá th·ªëng c·∫£nh b√°o ch√°y (ESP32 + MQTT)</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 16px; background:#0b1020; color:#e8edf7; transition: background .25s ease; }
    body.alarm { background:#0e2f1b; } /* n·ªÅn xanh khi chu√¥ng ƒëang b√°o */

    h1 { margin: 0 0 16px; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); }
    .card { background:#121833; border:1px solid #20295a; border-radius:16px; padding:16px; box-shadow:0 10px 24px rgba(0,0,0,.25); }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, select { background:#0f172a; color:#e2e8f0; border:1px solid #334155; padding:8px 10px; border-radius:8px; }
    button { background:#334155; color:#e2e8f0; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button:hover { filter:brightness(1.1); }
    .pill { padding:4px 10px; border-radius:999px; font-weight:700; display:inline-flex; align-items:center; gap:6px; }
    .ok{ background:#193d2f; color:#86efac; } .bad{ background:#4a1d1d; color:#fecaca; } .warn{ background:#3b2d14; color:#fde68a; }
    .led-on { background:#173a2a; color:#86efac; }     /* LED ON xanh */
    .led-off{ background:#4a1d1d; color:#fecaca; }     /* LED OFF ƒë·ªè */
    .icon-dot { width:10px; height:10px; border-radius:999px; background:#94a3b8; }
    .icon-dot.green { background:#22c55e; }
    .icon-dot.red   { background:#ef4444; }

    /* ---- Log UI ---- */
    .logwrap { max-height:260px; overflow:auto; background:#0f172a; border-radius:8px; padding:8px; }
    .log-line { display:flex; gap:8px; align-items:flex-start; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12.5px; line-height:1.3; }
    .log-time { opacity:.7; min-width:88px; }
    .log-tag { padding:2px 6px; border-radius:6px; font-weight:700; }
    .tag-rx{  background:#12381e; color:#86efac; }
    .tag-tx{  background:#0f2d3a; color:#93c5fd; }
    .tag-sys{ background:#2a2438; color:#e9d5ff; }
    .tag-err{ background:#4a1d1d; color:#fecaca; }
    .log-text { white-space:pre-wrap; word-break:break-word; }
    .controls { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
  </style>
</head>
<body>
  <h1>üî• H·ªÜ TH·ªêNG C·∫¢NH B√ÅO CH√ÅY</h1>

  <div class="grid">
    <!-- K·∫øt n·ªëi -->
    <div class="card">
      <h3>K·∫øt n·ªëi MQTT</h3>
      <div class="row">
        <input id="brokerUrl" style="flex:1 1 320px" value="wss://test.mosquitto.org:8081/mqtt" />
        <input id="topicBase" value="iot/fire1" />
        <button id="btnConnect">K·∫øt n·ªëi</button>
        <span id="connState" class="pill warn">Ch∆∞a k·∫øt n·ªëi</span>
      </div>
      <small>G·ª£i √Ω: ƒëa s·ªë broker WebSocket d√πng ƒë∆∞·ªùng d·∫´n <code>/mqtt</code>. N·∫øu trang ch·∫°y HTTPS, h√£y d√πng <b>wss://</b>.</small>
    </div>

    <!-- Tr·∫°ng th√°i hi·ªán t·∫°i -->
    <div class="card">
      <h3>Tr·∫°ng th√°i thi·∫øt b·ªã</h3>
      <p>Thi·∫øt b·ªã: <b id="devStatus">unknown</b></p>
      <p>Nhi·ªát ƒë·ªô: <b id="tempNow">--</b> ¬∞C ‚Äî ƒê·ªô ·∫©m: <b id="humNow">--</b> %</p>
      <p>Kh√≥i (ADC): <b id="smokeNow">--</b></p>

      <div class="row" style="align-items:center; margin-top:6px;">
        <span>LED:</span>
        <span id="ledPill" class="pill">
          <span id="ledDot" class="icon-dot"></span>
          <span id="ledText">‚Äî</span>
        </span>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnSilence">T·∫Øt chu√¥ng 60s</button>
        <button id="btnLedOn">LED ON</button>
        <button id="btnLedOff">LED OFF</button>
      </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="card" style="grid-column:1/-1;">
      <div class="row" style="justify-content:space-between;">
        <h3 style="margin:0">Bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô</h3>
        <div class="row">
          <label for="mode">Ch·∫ø ƒë·ªô:</label>
          <select id="mode">
            <option value="realtime">Realtime</option>
            <option value="today">Trong ng√†y (theo gi·ªù)</option>
            <option value="session">Theo bu·ªïi (s√°ng/tr∆∞a/chi·ªÅu/t·ªëi)</option>
          </select>
        </div>
      </div>
      <canvas id="chart" height="140"></canvas>
    </div>

    <!-- Log -->
    <div class="card" style="grid-column:1/-1;">
      <h3>Log</h3>
      <div class="controls">
        <button id="btnClear">Clear</button>
        <button id="btnDownload">Download .txt</button>
        <label><input type="checkbox" id="autoScroll" checked /> Auto-scroll</label>
      </div>
      <div id="logWrap" class="logwrap"><div id="logList"></div></div>
    </div>
  </div>

  <!-- C·∫£nh b√°o -->
  <div id="alertBanner" class="banner" style="display:none; position:fixed; inset:0; place-items:center; background:rgba(0,0,0,.6);">
    <div class="inner" style="background:#1b0b0b; border:2px solid #7f1d1d; padding:24px; border-radius:16px; text-align:center;">
      <h2>‚ö†Ô∏è PH√ÅT HI·ªÜN CH√ÅY</h2>
      <p id="alertText">Chi ti·∫øt...</p>
      <div class="row" style="justify-content:center; margin-top:12px;">
        <button id="btnAck">ƒê√£ hi·ªÉu</button>
        <button id="btnAckSilence">T·∫Øt chu√¥ng 60s</button>
      </div>
    </div>
  </div>

  <!-- Beep nh·∫π (t√πy ch·ªçn) -->
  <audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <!-- Th∆∞ vi·ªán -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ====== Helpers ======
    const $ = (id) => document.getElementById(id);
    function setConnState(s, cls='warn') { const el=$('connState'); el.textContent=s; el.className = `pill ${cls}`; }

    // ---- Log helpers (d√≤ng, timestamp, nh√£n) ----
    const logStore = [];
    function nowTs() {
      const d = new Date();
      return d.toLocaleTimeString(); // ho·∫∑c d.toLocaleString()
    }
    function logLine(kind, text) {
      const list = $('logList'), scroller = $('logWrap');
      const line = document.createElement('div'); line.className = 'log-line';
      const tm = document.createElement('span'); tm.className = 'log-time'; tm.textContent = nowTs();
      const tag = document.createElement('span'); tag.className = 'log-tag ' + (kind==='rx'?'tag-rx':kind==='tx'?'tag-tx':kind==='err'?'tag-err':'tag-sys'); tag.textContent = kind.toUpperCase();
      const body = document.createElement('span'); body.className = 'log-text'; body.textContent = text;
      line.append(tm, tag, body); list.appendChild(line);
      logStore.push(`[${tm.textContent}] ${kind.toUpperCase()} ${text}`);
      if ($('autoScroll').checked) scroller.scrollTop = scroller.scrollHeight;
    }
    $('btnClear').onclick = () => { $('logList').innerHTML = ''; logStore.length = 0; };
    $('btnDownload').onclick = () => {
      const blob = new Blob([logStore.join('\n')], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `mqtt-log-${Date.now()}.txt`; a.click();
      URL.revokeObjectURL(a.href);
    };

    // ====== State ======
    let client = null;
    let topicBase = 'iot/fire1';
    let dataRealtime = [];     // {t:Date, v:number}
    let dataToday = new Map(); // hour -> [vals]
    let ledState = null;       // null: ch∆∞a bi·∫øt | true: ON | false: OFF
    let alarmState = false;    // chu√¥ng/alert ƒëang b√°o?

    // Ng∆∞·ª°ng ƒë·ªÉ suy ra h·∫øt b√°o ƒë·ªông (kh·ªõp ESP32)
    const SMOKE_THRESHOLD = 1700;
    const TEMP_THRESHOLD  = 55;

    // ====== Chart ======
    const ctx = $('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Nhi·ªát ƒë·ªô (¬∞C)', data: [], fill:false, tension: .2 }] },
      options: { responsive: true, scales: { y: { beginAtZero:false } } }
    });

    function updateChartRealtime() {
      chart.data.labels = dataRealtime.map(p => p.t.toLocaleTimeString());
      chart.data.datasets[0].data = dataRealtime.map(p => p.v);
      chart.update();
    }
    function updateChartToday() {
      const hours = [...dataToday.keys()].sort((a,b)=>a-b);
      const avg = (arr) => arr.reduce((s,x)=>s+x,0)/arr.length;
      chart.data.labels = hours.map(h=>h+':00');
      chart.data.datasets[0].data = hours.map(h=> avg(dataToday.get(h)));
      chart.update();
    }
    function updateChartSession() {
      const buckets = { 'S√°ng':[], 'Tr∆∞a':[], 'Chi·ªÅu':[], 'T·ªëi':[] };
      for (const {t,v} of dataRealtime) {
        const h = t.getHours();
        if (h>=5 && h<11) buckets['S√°ng'].push(v);
        else if (h>=11 && h<13) buckets['Tr∆∞a'].push(v);
        else if (h>=13 && h<17) buckets['Chi·ªÅu'].push(v);
        else if (h>=17 && h<22) buckets['T·ªëi'].push(v);
      }
      const avg = (arr) => arr.length? (arr.reduce((s,x)=>s+x,0)/arr.length) : null;
      chart.data.labels = Object.keys(buckets);
      chart.data.datasets[0].data = Object.values(buckets).map(avg);
      chart.update();
    }
    $('mode').addEventListener('change', () => {
      const m = $('mode').value;
      if (m==='realtime') updateChartRealtime();
      else if (m==='today') updateChartToday();
      else updateChartSession();
    });

    // ====== LED pill UI ======
    function updateLedPill() {
      const pill = $('ledPill'), dot = $('ledDot'), text = $('ledText');
      pill.classList.remove('led-on','led-off');
      dot.classList.remove('green','red');
      if (ledState === true) {
        pill.classList.add('led-on');
        dot.classList.add('green');
        text.textContent = 'ON';
      } else if (ledState === false) {
        pill.classList.add('led-off');
        dot.classList.add('red');
        text.textContent = 'OFF';
      } else {
        text.textContent = '‚Äî'; // kh√¥ng m√†u nh∆∞ c≈©
      }
    }
    function setAlarm(on) {
      alarmState = on;
      document.body.classList.toggle('alarm', on); // n·ªÅn xanh khi b√°o
    }

    // ====== Notifications ======
    function ensureNotif() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }
    function showAlert(payload) {
      const text = `üî• FIRE @ ${new Date(payload.ts*1000).toLocaleString()} ‚Äî T=${payload.temp_c}¬∞C, smoke=${payload.smoke_raw}`;
      $('alertText').textContent = text;
      $('alertBanner').style.display = 'grid';
      try { $('beep').play(); } catch {}
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('Ph√°t hi·ªán ch√°y', { body: text });
      }
    }
    $('btnAck').onclick = () => { $('alertBanner').style.display = 'none'; };
    $('btnAckSilence').onclick = () => {
      publish(`${topicBase}/cmd/buzzer`, 'silence:60');
      $('alertBanner').style.display = 'none';
      setAlarm(false); // t·∫Øt n·ªÅn v√¨ ƒë√£ silence chu√¥ng
    };

    // ====== MQTT ======
    function connect() {
      const url = $('brokerUrl').value.trim();
      topicBase = $('topicBase').value.trim() || 'iot/fire1';
      ensureNotif();

      client = mqtt.connect(url, { clientId: 'webdash-' + Math.random().toString(16).slice(2), keepalive: 60, clean: true });

      client.on('connect', () => {
        setConnState('ƒê√£ k·∫øt n·ªëi','ok');
        logLine('sys', `[MQTT] connected to ${url}`);
        client.subscribe(`${topicBase}/#`);
      });
      client.on('reconnect', () => setConnState('ƒêang k·∫øt n·ªëi l·∫°i...', 'warn'));
      client.on('close', () => setConnState('M·∫•t k·∫øt n·ªëi', 'bad'));
      client.on('error', (e) => { logLine('err', '[MQTT error] ' + e.message); setConnState('L·ªói', 'bad'); });
      client.on('message', (topic, msg) => handleMsg(topic, msg.toString()));
    }

    function publish(topic, payload) {
      if (!client || !client.connected) return;
      client.publish(topic, payload);
      logLine('tx', `‚Üí ${topic}: ${payload}`);
    }

    function handleMsg(topic, s) {
      logLine('rx', `‚Üê ${topic}: ${s}`);
      if (topic.endsWith('/status')) {
        $('devStatus').textContent = s;
      } else if (topic.endsWith('/telemetry')) {
        try {
          const o = JSON.parse(s);
          $('tempNow').textContent = o.temp_c?.toFixed?.(1) ?? o.temp_c;
          $('humNow').textContent = o.hum;
          $('smokeNow').textContent = o.smoke_raw;

          const t = new Date((o.ts || Date.now()/1000)*1000);
          dataRealtime.push({ t, v: o.temp_c });
          if (dataRealtime.length>200) dataRealtime.shift();

          const h = t.getHours();
          if (!dataToday.has(h)) dataToday.set(h, []);
          dataToday.get(h).push(o.temp_c);

          // Suy ra tr·∫°ng th√°i chu√¥ng t·ª´ telemetry (kh·ªõp ng∆∞·ª°ng ESP32)
          const isFire = (typeof o.smoke_raw === 'number' && o.smoke_raw >= SMOKE_THRESHOLD) ||
                         (typeof o.temp_c === 'number' && o.temp_c >= TEMP_THRESHOLD);
          setAlarm(isFire);
          if (isFire) { ledState = true; updateLedPill(); } // th∆∞·ªùng khi alert LED c≈©ng ON

          const m = $('mode').value;
          if (m==='realtime') updateChartRealtime();
          else if (m==='today') updateChartToday();
          else updateChartSession();
        } catch {}
      } else if (topic.endsWith('/alert')) {
        try {
          const payload = JSON.parse(s);
          setAlarm(true);          // n·ªÅn xanh khi c√≥ alert
          ledState = true;         // gi·∫£ ƒë·ªãnh LED b·∫≠t khi b√°o
          updateLedPill();
          showAlert(payload);
        } catch {
          setAlarm(true);
          ledState = true; updateLedPill();
          showAlert({ ts: Date.now()/1000, temp_c: '?', smoke_raw: '?' });
        }
      }
    }

    // ====== Buttons ======
    $('btnConnect').onclick = connect;
    $('btnSilence').onclick = () => {
      publish(`${topicBase}/cmd/buzzer`, 'silence:60');
      setAlarm(false); // t·∫Øt n·ªÅn v√¨ ƒë√£ silence chu√¥ng
    };
    $('btnLedOn').onclick   = () => { publish(`${topicBase}/cmd/led`, 'on');  ledState = true;  updateLedPill(); };
    $('btnLedOff').onclick  = () => { publish(`${topicBase}/cmd/led`, 'off'); ledState = false; updateLedPill(); };
  </script>
</body>
</html>
